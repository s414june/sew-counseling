import { defineEventHandler, getQuery, setHeader } from "h3";
import { buildSitemapIndex } from "../sitemap/builder/index.mjs";
import { setupCache } from "../util/cache.mjs";
import { createSitePathResolver, useRuntimeConfig } from "#imports";
import { getRouteRulesForPath } from "#internal/nitro/route-rules";
import pages from "#nuxt-simple-sitemap/pages.mjs";
import { useNitroApp } from "#internal/nitro";
import extraRoutes from "#nuxt-simple-sitemap/extra-routes.mjs";
export default defineEventHandler(async (e) => {
  const { moduleConfig, buildTimeMeta } = useRuntimeConfig()["nuxt-simple-sitemap"];
  const { cachedSitemap, cache } = await setupCache(e, "sitemap_index");
  let sitemap = cachedSitemap;
  const nitro = useNitroApp();
  const callHook = async (ctx) => {
    await nitro.hooks.callHook("sitemap:resolved", ctx);
  };
  if (!sitemap) {
    const canonicalQuery = getQuery(e).canonical;
    const isShowingCanonical = typeof canonicalQuery !== "undefined" && canonicalQuery !== "false";
    sitemap = (await buildSitemapIndex({
      moduleConfig,
      buildTimeMeta,
      getRouteRulesForPath,
      callHook,
      extraRoutes,
      canonicalUrlResolver: createSitePathResolver(e, { canonical: isShowingCanonical || !process.dev, absolute: true, withBase: true }),
      relativeBaseUrlResolver: createSitePathResolver(e, { absolute: false, withBase: true }),
      pages
    })).xml;
    const nitro2 = useNitroApp();
    const ctx = { sitemap, sitemapName: "sitemap" };
    await nitro2.hooks.callHook("sitemap:output", ctx);
    sitemap = ctx.sitemap;
    await cache(sitemap);
  }
  setHeader(e, "Content-Type", "text/xml; charset=UTF-8");
  if (!process.dev)
    setHeader(e, "Cache-Control", "max-age=600, must-revalidate");
  return sitemap;
});
